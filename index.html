<!doctype html>
<html lang="hr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f17" />
  <meta name="description" content="Jednostavan budget tracker (offline-first) kao PWA." />

  <link rel="manifest" href="./manifest.json" />
  <link rel="icon" href="./icon.svg" type="image/svg+xml" />
  <link rel="apple-touch-icon" href="./icon.svg" />

  <title>Budget Tracker</title>

  <style>
    :root{
      --bg:#0b0f17;
      --card:#111827;
      --muted:#94a3b8;
      --text:#e5e7eb;
      --line:rgba(148,163,184,.18);
      --good:#22c55e;
      --bad:#ef4444;
      --accent:#60a5fa;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --r: 18px;
      --pad: 16px;
      --max: 980px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 500px at 20% -10%, rgba(96,165,250,.20), transparent 60%),
        radial-gradient(700px 400px at 110% 10%, rgba(34,197,94,.15), transparent 55%),
        radial-gradient(600px 380px at 10% 110%, rgba(239,68,68,.12), transparent 55%),
        var(--bg);
      min-height:100vh;
      padding-bottom: calc(env(safe-area-inset-bottom) + 24px);
    }
    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(14px);
      background: linear-gradient(to bottom, rgba(11,15,23,.85), rgba(11,15,23,.55));
      border-bottom: 1px solid var(--line);
    }
    .wrap{max-width:var(--max); margin:0 auto; padding: 14px var(--pad);}
    .top{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .brand{
      display:flex; align-items:center; gap:12px; min-width: 220px;
    }
    .logo{
      width:40px; height:40px; border-radius:14px;
      background: linear-gradient(135deg, rgba(96,165,250,.95), rgba(34,197,94,.75));
      box-shadow: var(--shadow);
      display:grid; place-items:center;
      border: 1px solid rgba(255,255,255,.10);
    }
    .logo svg{opacity:.95}
    h1{font-size: 16px; margin:0; letter-spacing:.2px}
    .sub{font-size:12px; color:var(--muted); margin-top:2px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border: 1px solid var(--line);
      background: rgba(17,24,39,.55);
      font-size:12px; color:var(--muted);
      white-space:nowrap;
    }
    .dot{width:8px;height:8px;border-radius:999px;background:var(--good); box-shadow:0 0 0 3px rgba(34,197,94,.15)}
    .dot.off{background:#f59e0b; box-shadow:0 0 0 3px rgba(245,158,11,.15)}
    main{max-width:var(--max); margin: 0 auto; padding: 18px var(--pad);}

    .grid{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:20px;
    }
    @media (max-width: 920px){
      .grid{
        grid-template-columns: 1fr;
        gap: 24px;
      }
      .brand{min-width:0}
      /* Na tabletu/mobileu: Dodaj transakciju prvo */
      .grid > section:first-child { order: 1; }
      .grid > section:last-child { order: 2; }
    }
    @media (max-width: 600px){
      :root{
        --pad: 16px;
        --r: 16px;
      }
      main{
        padding: 20px var(--pad);
      }
      .grid{
        gap: 20px;
      }
      .top{
        flex-wrap: wrap;
        gap: 12px;
      }
      .brand{
        flex: 1 1 100%;
      }
      .pill{
        margin-left: auto;
      }
      .logo{
        width: 36px;
        height: 36px;
        border-radius: 12px;
      }
      h1{font-size: 15px}
      .card .hd{
        flex-direction: column;
        align-items: flex-start;
        gap: 14px;
        padding: 16px;
      }
      .card .hd h2{
        text-align: left;
      }
      .card .hd > div{
        align-self: flex-start;
      }
      .card .hd .filters{
        min-width: 0 !important;
        width: 100%;
      }
      .card .bd{
        padding: 18px 16px;
      }
    }
    .card{
      background: rgba(17,24,39,.70);
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding: 18px 18px 14px 18px;
      display:flex; justify-content:space-between; gap:15 px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(to bottom, rgba(255,255,255,.02), transparent);
    }
    .card .hd h2{
      margin:0;
      font-size: 15px;
      letter-spacing:.2px;
      font-weight: 600;
      text-align: left;
    }
    .card .bd{padding: 20px 18px}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:14px}
    .row + .row{margin-top: 14px}
    @media (max-width: 520px){ 
      .row{grid-template-columns:1fr; gap: 16px} 
    }
    label{display:block; font-size:13px; color:var(--muted); margin: 0 0 8px; font-weight: 500}
    input, select, button, textarea{
      width:100%;
      border-radius: 14px;
      border: 1px solid rgba(148,163,184,.20);
      background: rgba(11,15,23,.55);
      color: var(--text);
      padding: 14px 14px;
      outline:none;
      font-size:16px; /* Prevents iOS zoom on focus */
      -webkit-appearance: none;
      appearance: none;
    }
    select{
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%2394a3b8' d='M2 4l4 4 4-4'/%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 12px center;
      padding-right: 32px;
    }
    textarea{min-height:42px; resize:vertical}
    input:focus, select:focus, textarea:focus{
      border-color: rgba(96,165,250,.65);
      box-shadow: 0 0 0 4px rgba(96,165,250,.12);
    }
    .actions{display:flex; gap:12px; flex-wrap:wrap; margin-top:16px}
    @media (max-width: 520px){
      .actions{
        flex-direction: column;
        gap: 10px;
      }
      .actions .btn{
        width: 100%;
      }
    }
    .btn{
      cursor:pointer;
      border: 1px solid rgba(148,163,184,.20);
      background: rgba(17,24,39,.70);
      transition: transform .06s ease, border-color .2s ease, background .2s ease;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      min-height: 44px; /* Apple HIG minimum touch target */
    }
    .btn:hover{border-color: rgba(96,165,250,.55)}
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      background: linear-gradient(135deg, rgba(96,165,250,.92), rgba(59,130,246,.70));
      border-color: rgba(96,165,250,.65);
      color: #0b0f17;
      font-weight:700;
    }
    .btn.danger{
      background: rgba(239,68,68,.12);
      border-color: rgba(239,68,68,.35);
    }
    .btn.ghost{
      background: transparent;
    }
    .btn.small{padding:10px 12px; font-size:13px}
    .btn.inline{width:auto}

    .summary{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
    }
    @media (max-width: 520px){ 
      .summary{
        grid-template-columns: 1fr;
        gap: 10px;
      }
      .filters{
        flex-direction: column;
        gap: 12px;
      }
      .filters > *{
        width: 100%;
        flex: none;
      }
      .filters .inlineGroup{
        width: 100%;
        justify-content: stretch;
      }
      .filters .inlineGroup .btn{
        flex: 1;
      }
    }
    .kpi{
      padding: 16px;
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(11,15,23,.45);
    }
    .kpi .t{font-size:13px; color:var(--muted); font-weight: 500}
    .kpi .v{font-size: 20px; font-family:var(--mono); margin-top: 8px; font-weight: 600}
    .kpi.good .v{color: rgba(34,197,94,.95)}
    .kpi.bad .v{color: rgba(239,68,68,.95)}

    .filters{
      display:flex; gap:12px; flex-wrap:wrap; align-items:center;
    }
    .filters > *{flex:1}
    .filters .inlineGroup{display:flex; gap:12px; align-items:center}
    .filters .inlineGroup .btn{flex:0 0 auto}

    table{
      width:100%;
      border-collapse: collapse;
      font-size:13px;
    }
    th, td{
      padding:10px 8px;
      border-bottom: 1px solid rgba(148,163,184,.14);
      vertical-align: top;
    }
    th{color:var(--muted); font-weight:600; text-align:left; font-size:12px}
    td .mono{font-family:var(--mono)}
    .type{
      display:inline-flex; align-items:center; gap:7px;
      padding: 6px 10px; border-radius: 999px;
      border: 1px solid rgba(148,163,184,.16);
      background: rgba(11,15,23,.35);
      font-size:12px;
      white-space:nowrap;
    }
    .type.income{border-color: rgba(34,197,94,.30)}
    .type.expense{border-color: rgba(239,68,68,.30)}
    .amount.income{color: rgba(34,197,94,.95)}
    .amount.expense{color: rgba(239,68,68,.95)}
    .note{color:var(--muted); font-size:12px; margin-top:4px; line-height:1.35}

    .empty{
      padding: 20px;
      border: 1px dashed rgba(148,163,184,.25);
      border-radius: 16px;
      color: var(--muted);
      background: rgba(11,15,23,.35);
      margin-top: 20px;
    }
    .empty .actions{
      flex-wrap: wrap;
      margin-top: 14px;
    }
    @media (max-width: 520px){
      .empty .actions .btn,
      .empty .actions label{
        flex: 1 1 calc(50% - 5px);
        min-width: 120px;
        text-align: center;
        justify-content: center;
      }
    }

    /* Mobile table improvements */
    @media (max-width: 600px){
      table{font-size: 12px}
      th, td{padding: 10px 6px}
      .type{padding: 5px 8px; font-size: 11px}
      .btn.small{padding: 8px 10px; font-size: 12px}
      td .mono{font-size: 12px}
      .note{font-size: 11px}
    }
    @media (max-width: 420px){
      /* Stack table as cards on very small screens */
      table, thead, tbody, th, td, tr{
        display: block;
      }
      thead{
        position: absolute;
        left: -9999px;
      }
      tr{
        border: 1px solid var(--line);
        border-radius: 14px;
        margin-bottom: 14px;
        padding: 16px;
        background: rgba(11,15,23,.35);
      }
      td{
        border: none;
        padding: 8px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      td::before{
        content: attr(data-label);
        font-weight: 600;
        color: var(--muted);
        font-size: 11px;
        text-transform: uppercase;
        margin-right: 10px;
      }
      td.right{
        justify-content: space-between;
      }
      .note{
        display: block;
        margin-top: 4px;
        text-align: right;
      }
    }

    .toast{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: calc(env(safe-area-inset-bottom) + 16px);
      background: rgba(17,24,39,.92);
      border: 1px solid rgba(148,163,184,.22);
      padding: 12px 16px;
      border-radius: 999px;
      box-shadow: var(--shadow);
      font-size: 14px;
      color: var(--text);
      opacity:0;
      pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      max-width: calc(100vw - 32px);
      text-align: center;
      z-index: 100;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-6px);
    }
    .muted{color:var(--muted)}
    .right{text-align:right}
    .nowrap{white-space:nowrap}

    /* Charts & Stats */
    .stats-grid{
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }
    @media (max-width: 700px){
      .stats-grid{
        grid-template-columns: 1fr;
      }
    }
    .chart-box{
      background: rgba(11,15,23,.45);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 20px;
    }
    .chart-box h3{
      margin: 0 0 16px 0;
      font-size: 14px;
      color: var(--muted);
      font-weight: 600;
    }
    .pie-container{
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 20px;
      flex-wrap: wrap;
    }
    .pie-chart{
      width: 140px;
      height: 140px;
      border-radius: 50%;
      position: relative;
      flex-shrink: 0;
    }
    .pie-legend{
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-width: 120px;
    }
    .pie-legend-item{
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
    }
    .pie-legend-dot{
      width: 10px;
      height: 10px;
      border-radius: 3px;
      flex-shrink: 0;
    }
    .pie-legend-label{
      flex: 1;
      color: var(--muted);
    }
    .pie-legend-value{
      font-family: var(--mono);
      font-size: 11px;
    }
    .line-chart{
      width: 100%;
      height: 160px;
    }
    .weekly-limit{
      background: rgba(11,15,23,.45);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 20px;
      margin-top: 20px;
    }
    .weekly-limit h3{
      margin: 0 0 12px 0;
      font-size: 14px;
      color: var(--muted);
      font-weight: 600;
    }
    .limit-header{
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .limit-input-group{
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .limit-input-group input{
      width: 100px;
      padding: 10px 12px;
      font-size: 14px;
    }
    .limit-input-group .btn{
      min-height: 40px;
      padding: 8px 14px;
    }
    .progress-container{
      background: rgba(148,163,184,.12);
      border-radius: 12px;
      height: 24px;
      overflow: hidden;
      position: relative;
    }
    .progress-bar{
      height: 100%;
      border-radius: 12px;
      transition: width 0.4s ease, background 0.3s ease;
      background: linear-gradient(90deg, var(--good), #4ade80);
    }
    .progress-bar.warning{
      background: linear-gradient(90deg, #f59e0b, #fbbf24);
    }
    .progress-bar.danger{
      background: linear-gradient(90deg, var(--bad), #f87171);
    }
    .progress-text{
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 12px;
      font-weight: 600;
      font-family: var(--mono);
      color: var(--text);
      text-shadow: 0 1px 2px rgba(0,0,0,.5);
    }
    .limit-stats{
      display: flex;
      justify-content: space-between;
      margin-top: 12px;
      font-size: 13px;
    }
    .limit-stats .spent{color: var(--bad)}
    .limit-stats .remaining{color: var(--good)}
    .limit-stats .remaining.over{color: var(--bad)}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
            <path d="M5 12.5c3.5-6 10.5-6 14 0" stroke="rgba(11,15,23,.85)" stroke-width="2.2" stroke-linecap="round"/>
            <path d="M7.5 13.5c2.5-4 6.5-4 9 0" stroke="rgba(11,15,23,.75)" stroke-width="2.2" stroke-linecap="round"/>
            <path d="M10 15c1.2-2 2.8-2 4 0" stroke="rgba(11,15,23,.65)" stroke-width="2.2" stroke-linecap="round"/>
          </svg>
        </div>
        <div>
          <h1>Budget Tracker</h1>
          <div class="sub">Offline-first PWA â€¢ spremanje u browser</div>
        </div>
      </div>

      <div class="pill" id="statusPill" title="PWA status">
        <span class="dot" id="statusDot"></span>
        <span id="statusText">Online</span>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <!-- LEFT -->
    <section class="card">
      <div class="hd">
        <h2>Dodaj transakciju</h2>
        <div class="muted" style="font-size:12px">Valuta: <span class="mono">EUR</span></div>
      </div>
      <div class="bd">
        <div class="row">
          <div>
            <label for="type">Tip</label>
            <select id="type">
              <option value="expense">Rashod</option>
              <option value="income">Prihod</option>
            </select>
          </div>
          <div>
            <label for="date">Datum</label>
            <input id="date" type="date" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="amount">Iznos</label>
            <input id="amount" inputmode="decimal" placeholder="npr. 12.50" />
          </div>
          <div>
            <label for="category">Kategorija</label>
            <select id="category"></select>
          </div>
        </div>

        <div class="row" style="grid-template-columns: 1fr">
          <div>
            <label for="note">Napomena (opcionalno)</label>
            <textarea id="note" placeholder="npr. kava + sendviÄ"></textarea>
          </div>
        </div>

        <div class="actions">
          <button class="btn primary small" id="addBtn">Spremi</button>
          <button class="btn small ghost" id="resetBtn" type="button">Reset forme</button>
        </div>

        <div class="empty">
          <div style="font-weight:700; margin-bottom:6px">Backup / prijenos na drugi ureÄ‘aj</div>
          <div class="muted" style="margin-bottom:10px">
            Export spremi kao <span class="mono">.json</span>, pa import na mob/komp.
          </div>
          <div class="actions">
            <button class="btn small" id="exportBtn" type="button">Export JSON</button>
            <label class="btn small inline" style="display:inline-flex; align-items:center; gap:10px; cursor:pointer;">
              Import JSON
              <input id="importFile" type="file" accept="application/json" style="display:none" />
            </label>
            <button class="btn small" id="csvBtn" type="button">Export CSV</button>
          </div>
        </div>

      </div>
    </section>

    <!-- RIGHT -->
    <section class="card">
      <div class="hd">
        <h2>Pregled</h2>
        <div class="filters" style="min-width: 340px;">
          <select id="monthFilter" title="Mjesec"></select>
          <select id="dayFilter" title="Dan"></select>
          <select id="catFilter" title="Kategorija"></select>
        </div>
      </div>
      <div class="bd">
        <div class="summary">
          <div class="kpi good">
            <div class="t">Prihodi</div>
            <div class="v" id="kpiIncome">â‚¬0.00</div>
          </div>
          <div class="kpi bad">
            <div class="t">Rashodi</div>
            <div class="v" id="kpiExpense">â‚¬0.00</div>
          </div>
          <div class="kpi">
            <div class="t">Saldo</div>
            <div class="v" id="kpiNet">â‚¬0.00</div>
          </div>
        </div>

        <div class="filters" style="margin-top:16px">
          <input id="search" placeholder="Search: kategorija, napomenaâ€¦" />
          <div class="inlineGroup">
            <button class="btn small danger inline" id="clearBtn" type="button">ObriÅ¡i sve</button>
          </div>
        </div>

        <div style="margin-top:16px; overflow:auto; border-radius: 16px; border:1px solid rgba(148,163,184,.14)">
          <table>
            <thead>
              <tr>
                <th>Datum</th>
                <th>Tip</th>
                <th>Kategorija</th>
                <th class="right">Iznos</th>
                <th class="right">Akcije</th>
              </tr>
            </thead>
            <tbody id="rows"></tbody>
          </table>
        </div>

        <div id="emptyState" class="empty" style="display:none">
          Nema transakcija za odabrane filtere.
        </div>

        <div class="muted" style="margin-top:16px; font-size:13px">
          Tip: ovo sprema u <span class="mono">localStorage</span>. Za sync izmeÄ‘u ureÄ‘aja kasnije moÅ¾emo dodati backend (npr. Supabase).
        </div>

        <!-- Weekly Limit Progress Bar -->
        <div class="weekly-limit">
          <h3>ðŸ“Š Tjedni limit potroÅ¡nje</h3>
          <div class="limit-header">
            <div class="limit-input-group">
              <input type="number" id="weeklyLimitInput" placeholder="Limit â‚¬" inputmode="decimal" />
              <button class="btn small primary" id="setLimitBtn">Postavi</button>
            </div>
            <div class="muted" style="font-size:12px">
              Ovaj tjedan: <span id="weekRange" class="mono"></span>
            </div>
          </div>
          <div class="progress-container">
            <div class="progress-bar" id="progressBar" style="width: 0%"></div>
            <div class="progress-text" id="progressText">0%</div>
          </div>
          <div class="limit-stats">
            <div>PotroÅ¡eno: <span class="spent mono" id="weeklySpent">â‚¬0.00</span></div>
            <div>Preostalo: <span class="remaining mono" id="weeklyRemaining">â‚¬0.00</span></div>
          </div>
        </div>

        <!-- Charts -->
        <div class="stats-grid">
          <div class="chart-box">
            <h3>ðŸ¥§ Raspodjela troÅ¡kova po kategorijama</h3>
            <div class="pie-container">
              <div class="pie-chart" id="pieChart"></div>
              <div class="pie-legend" id="pieLegend"></div>
            </div>
          </div>
          <div class="chart-box">
            <h3>ðŸ“ˆ TroÅ¡enje kroz vrijeme (zadnjih 14 dana)</h3>
            <svg class="line-chart" id="lineChart" viewBox="0 0 400 160" preserveAspectRatio="xMidYMid meet"></svg>
          </div>
        </div>

      </div>
    </section>
  </div>
</main>

<div class="toast" id="toast">Saved</div>

<script>
  // ---------- PWA SW register ----------
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(() => {});
    });
  }

  // ---------- Storage ----------
  const STORAGE_KEY = "budget_pwa_v1";
  const CATEGORIES = [
    "Food", "Coffee", "Transport", "Bills", "Shopping", "Subscriptions",
    "Health", "Entertainment", "Travel", "Gifts", "Other"
  ];

  const els = {
    type: document.getElementById("type"),
    date: document.getElementById("date"),
    amount: document.getElementById("amount"),
    category: document.getElementById("category"),
    note: document.getElementById("note"),
    addBtn: document.getElementById("addBtn"),
    resetBtn: document.getElementById("resetBtn"),
    exportBtn: document.getElementById("exportBtn"),
    importFile: document.getElementById("importFile"),
    csvBtn: document.getElementById("csvBtn"),
    monthFilter: document.getElementById("monthFilter"),
    dayFilter: document.getElementById("dayFilter"),
    catFilter: document.getElementById("catFilter"),
    search: document.getElementById("search"),
    clearBtn: document.getElementById("clearBtn"),
    rows: document.getElementById("rows"),
    emptyState: document.getElementById("emptyState"),
    kpiIncome: document.getElementById("kpiIncome"),
    kpiExpense: document.getElementById("kpiExpense"),
    kpiNet: document.getElementById("kpiNet"),
    toast: document.getElementById("toast"),
    statusDot: document.getElementById("statusDot"),
    statusText: document.getElementById("statusText"),
    // Charts & Limit
    weeklyLimitInput: document.getElementById("weeklyLimitInput"),
    setLimitBtn: document.getElementById("setLimitBtn"),
    weekRange: document.getElementById("weekRange"),
    progressBar: document.getElementById("progressBar"),
    progressText: document.getElementById("progressText"),
    weeklySpent: document.getElementById("weeklySpent"),
    weeklyRemaining: document.getElementById("weeklyRemaining"),
    pieChart: document.getElementById("pieChart"),
    pieLegend: document.getElementById("pieLegend"),
    lineChart: document.getElementById("lineChart"),
  };

  const EUR = new Intl.NumberFormat("hr-HR", { style: "currency", currency: "EUR" });

  function uid(){
    return Math.random().toString(16).slice(2) + "-" + Date.now().toString(16);
  }

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return [];
      const arr = JSON.parse(raw);
      return Array.isArray(arr) ? arr : [];
    }catch(e){
      return [];
    }
  }

  function saveState(items){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(items));
  }

  let items = loadState();

  // ---------- UI helpers ----------
  function toast(msg){
    els.toast.textContent = msg;
    els.toast.classList.add("show");
    setTimeout(() => els.toast.classList.remove("show"), 1300);
  }

  function setOnlineBadge(){
    const online = navigator.onLine;
    els.statusDot.classList.toggle("off", !online);
    els.statusText.textContent = online ? "Online" : "Offline";
  }
  window.addEventListener("online", setOnlineBadge);
  window.addEventListener("offline", setOnlineBadge);
  setOnlineBadge();

  // ---------- Init selects ----------
  function initCategories(){
    els.category.innerHTML = CATEGORIES.map(c => `<option value="${c}">${c}</option>`).join("");
    els.catFilter.innerHTML = [`<option value="all">Sve kategorije</option>`]
      .concat(CATEGORIES.map(c => `<option value="${c}">${c}</option>`)).join("");
  }

  function yyyyMm(d){
    const dt = new Date(d + "T00:00:00");
    if (Number.isNaN(dt.getTime())) return "";
    const y = dt.getFullYear();
    const m = String(dt.getMonth()+1).padStart(2,"0");
    return `${y}-${m}`;
  }

  function initMonths(){
    // build based on existing items + current month
    const set = new Set(items.map(it => yyyyMm(it.date)).filter(Boolean));
    set.add(yyyyMm(new Date().toISOString().slice(0,10)));

    const months = Array.from(set).sort((a,b) => b.localeCompare(a));
    const currentValue = els.monthFilter.value;
    els.monthFilter.innerHTML = [`<option value="all">Svi mjeseci</option>`]
      .concat(months.map(m => `<option value="${m}">${m}</option>`)).join("");
    
    // Restore previous selection if still valid
    if(currentValue && months.includes(currentValue)){
      els.monthFilter.value = currentValue;
    }
    
    initDays();
  }

  function initDays(){
    const selectedMonth = els.monthFilter.value;
    
    if(selectedMonth === "all"){
      // Show all unique days from all transactions
      const allDays = new Set(items.map(it => it.date).filter(Boolean));
      allDays.add(new Date().toISOString().slice(0,10));
      const days = Array.from(allDays).sort((a,b) => b.localeCompare(a));
      
      els.dayFilter.innerHTML = [`<option value="all">Svi dani</option>`]
        .concat(days.slice(0, 31).map(d => `<option value="${d}">${d}</option>`)).join("");
    } else {
      // Show days only for selected month
      const daysInMonth = items
        .filter(it => yyyyMm(it.date) === selectedMonth)
        .map(it => it.date);
      
      // Add today if it's in the selected month
      const today = new Date().toISOString().slice(0,10);
      if(yyyyMm(today) === selectedMonth){
        daysInMonth.push(today);
      }
      
      const uniqueDays = Array.from(new Set(daysInMonth)).sort((a,b) => b.localeCompare(a));
      
      els.dayFilter.innerHTML = [`<option value="all">Svi dani</option>`]
        .concat(uniqueDays.map(d => {
          const dayNum = d.split('-')[2];
          return `<option value="${d}">${dayNum}.</option>`;
        })).join("");
    }
    
    els.dayFilter.value = "all";
  }

  function resetForm(){
    els.type.value = "expense";
    els.amount.value = "";
    els.note.value = "";
    els.category.value = "Food";
    const today = new Date().toISOString().slice(0,10);
    els.date.value = today;
  }

  initCategories();
  resetForm();
  initMonths();

  // ---------- Add transaction ----------
  function parseAmount(v){
    // accept "12,50" or "12.50"
    const cleaned = String(v).trim().replace(/\s+/g,"").replace(",",".");
    const n = Number(cleaned);
    return Number.isFinite(n) ? n : NaN;
  }

  els.addBtn.addEventListener("click", () => {
    const type = els.type.value;
    const date = els.date.value;
    const category = els.category.value;
    const note = els.note.value.trim();
    const amount = parseAmount(els.amount.value);

    if(!date){ toast("Odaberi datum"); return; }
    if(!Number.isFinite(amount) || amount <= 0){ toast("UpiÅ¡i ispravan iznos"); return; }

    items.unshift({
      id: uid(),
      type,
      date,
      category,
      note,
      amount
    });

    saveState(items);
    initMonths();
    render();
    toast("Spremljeno âœ…");
    els.amount.value = "";
    els.note.value = "";
    els.amount.focus();
  });

  els.resetBtn.addEventListener("click", () => {
    resetForm();
    toast("Resetirano");
  });

  // ---------- Filters ----------
  [els.monthFilter, els.dayFilter, els.catFilter, els.search].forEach(el => {
    el.addEventListener("input", render);
    el.addEventListener("change", render);
  });

  // Update days when month changes
  els.monthFilter.addEventListener("change", () => {
    initDays();
    render();
  });

  function filteredItems(){
    const m = els.monthFilter.value;
    const d = els.dayFilter.value;
    const c = els.catFilter.value;
    const q = els.search.value.trim().toLowerCase();

    return items.filter(it => {
      if(m !== "all" && yyyyMm(it.date) !== m) return false;
      if(d !== "all" && it.date !== d) return false;
      if(c !== "all" && it.category !== c) return false;
      if(q){
        const hay = (it.category + " " + (it.note||"") + " " + it.type).toLowerCase();
        if(!hay.includes(q)) return false;
      }
      return true;
    });
  }

  // ---------- Render ----------
  function render(){
    const list = filteredItems();

    // KPIs for filtered set
    let income = 0, expense = 0;
    for(const it of list){
      if(it.type === "income") income += it.amount;
      else expense += it.amount;
    }
    const net = income - expense;

    els.kpiIncome.textContent = EUR.format(income);
    els.kpiExpense.textContent = EUR.format(expense);
    els.kpiNet.textContent = EUR.format(net);

    // Rows
    els.rows.innerHTML = "";
    if(list.length === 0){
      els.emptyState.style.display = "block";
      return;
    }
    els.emptyState.style.display = "none";

    for(const it of list){
      const tr = document.createElement("tr");

      const tdDate = document.createElement("td");
      tdDate.setAttribute("data-label", "Datum");
      tdDate.innerHTML = `<span class="mono">${it.date}</span>`;
      tr.appendChild(tdDate);

      const tdType = document.createElement("td");
      tdType.setAttribute("data-label", "Tip");
      tdType.innerHTML = `<span class="type ${it.type}">${it.type === "income" ? "Prihod" : "Rashod"}</span>`;
      tr.appendChild(tdType);

      const tdCat = document.createElement("td");
      tdCat.setAttribute("data-label", "Kategorija");
      tdCat.innerHTML = `<div>${it.category}${it.note ? `<div class="note">${escapeHtml(it.note)}</div>` : ""}</div>`;
      tr.appendChild(tdCat);

      const tdAmt = document.createElement("td");
      tdAmt.className = "right nowrap";
      tdAmt.setAttribute("data-label", "Iznos");
      tdAmt.innerHTML = `<span class="mono amount ${it.type}">${EUR.format(it.amount)}</span>`;
      tr.appendChild(tdAmt);

      const tdAct = document.createElement("td");
      tdAct.className = "right";
      tdAct.setAttribute("data-label", "");
      const del = document.createElement("button");
      del.className = "btn small danger inline";
      del.textContent = "Delete";
      del.addEventListener("click", () => {
        items = items.filter(x => x.id !== it.id);
        saveState(items);
        initMonths();
        render();
        toast("Obrisano");
      });
      tdAct.appendChild(del);
      tr.appendChild(tdAct);

      els.rows.appendChild(tr);
    }
  }

  function escapeHtml(str){
    return str.replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  // ---------- Export / Import ----------
  function download(filename, text, mime="application/json"){
    const blob = new Blob([text], {type: mime});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(() => URL.revokeObjectURL(a.href), 800);
  }

  els.exportBtn.addEventListener("click", () => {
    const payload = {
      version: 1,
      exportedAt: new Date().toISOString(),
      items
    };
    download(`budget-backup-${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(payload, null, 2));
    toast("Exportano");
  });

  els.importFile.addEventListener("change", async (e) => {
    const file = e.target.files && e.target.files[0];
    if(!file) return;

    try{
      const txt = await file.text();
      const data = JSON.parse(txt);
      const imported = Array.isArray(data) ? data : data.items;

      if(!Array.isArray(imported)) throw new Error("Invalid JSON structure");
      // minimal validation
      const clean = imported
        .filter(it => it && it.id && it.type && it.date && it.category && Number.isFinite(it.amount))
        .map(it => ({
          id: String(it.id),
          type: it.type === "income" ? "income" : "expense",
          date: String(it.date).slice(0,10),
          category: String(it.category),
          note: (it.note ? String(it.note) : ""),
          amount: Number(it.amount)
        }));

      // merge by id (keep newest first)
      const map = new Map(items.map(it => [it.id, it]));
      for(const it of clean) map.set(it.id, it);
      items = Array.from(map.values()).sort((a,b) => (b.date + b.id).localeCompare(a.date + a.id));

      saveState(items);
      initMonths();
      render();
      toast("Import uspjeÅ¡an âœ…");
    }catch(err){
      toast("Import failed");
      console.error(err);
    }finally{
      e.target.value = "";
    }
  });

  function toCSVRow(cols){
    // CSV safe quoting
    return cols.map(v => `"${String(v ?? "").replace(/"/g,'""')}"`).join(",");
  }

  els.csvBtn.addEventListener("click", () => {
    const header = toCSVRow(["date","type","category","amount","note"]);
    const lines = items.map(it => toCSVRow([it.date, it.type, it.category, it.amount, it.note]));
    const csv = [header].concat(lines).join("\n");
    download(`budget-${new Date().toISOString().slice(0,10)}.csv`, csv, "text/csv");
    toast("CSV exportano");
  });

  // ---------- Clear all ----------
  els.clearBtn.addEventListener("click", () => {
    const ok = confirm("Sigurno Å¾eliÅ¡ obrisati sve transakcije? (Ovo se ne moÅ¾e vratiti bez backup-a)");
    if(!ok) return;
    items = [];
    saveState(items);
    initMonths();
    render();
    toast("Obrisano sve");
  });

  // ---------- Weekly Limit ----------
  const LIMIT_KEY = "budget_weekly_limit";
  
  function loadLimit(){
    try{
      return Number(localStorage.getItem(LIMIT_KEY)) || 0;
    }catch(e){ return 0; }
  }
  
  function saveLimit(val){
    localStorage.setItem(LIMIT_KEY, String(val));
  }
  
  let weeklyLimit = loadLimit();
  els.weeklyLimitInput.value = weeklyLimit || "";
  
  function getWeekBounds(){
    const now = new Date();
    const day = now.getDay();
    const diff = day === 0 ? 6 : day - 1; // Monday as start
    const monday = new Date(now);
    monday.setDate(now.getDate() - diff);
    monday.setHours(0,0,0,0);
    
    const sunday = new Date(monday);
    sunday.setDate(monday.getDate() + 6);
    
    return { 
      start: monday.toISOString().slice(0,10), 
      end: sunday.toISOString().slice(0,10),
      startDate: monday,
      endDate: sunday
    };
  }
  
  function getWeeklyExpenses(){
    const { start, end } = getWeekBounds();
    return items
      .filter(it => it.type === "expense" && it.date >= start && it.date <= end)
      .reduce((sum, it) => sum + it.amount, 0);
  }
  
  function updateWeeklyLimit(){
    const { start, end } = getWeekBounds();
    els.weekRange.textContent = `${start.slice(5)} â€” ${end.slice(5)}`;
    
    const spent = getWeeklyExpenses();
    els.weeklySpent.textContent = EUR.format(spent);
    
    if(weeklyLimit > 0){
      const remaining = weeklyLimit - spent;
      const pct = Math.min((spent / weeklyLimit) * 100, 100);
      
      els.progressBar.style.width = pct + "%";
      els.progressText.textContent = pct.toFixed(0) + "%";
      
      // Color coding
      els.progressBar.classList.remove("warning", "danger");
      if(pct >= 100){
        els.progressBar.classList.add("danger");
      } else if(pct >= 80){
        els.progressBar.classList.add("warning");
      }
      
      els.weeklyRemaining.textContent = EUR.format(remaining);
      els.weeklyRemaining.classList.toggle("over", remaining < 0);
    } else {
      els.progressBar.style.width = "0%";
      els.progressText.textContent = "Postavi limit";
      els.weeklyRemaining.textContent = "â€”";
    }
  }
  
  els.setLimitBtn.addEventListener("click", () => {
    const val = parseFloat(els.weeklyLimitInput.value);
    if(Number.isFinite(val) && val > 0){
      weeklyLimit = val;
      saveLimit(weeklyLimit);
      updateWeeklyLimit();
      toast("Limit postavljen âœ…");
    } else {
      toast("UpiÅ¡i ispravan iznos");
    }
  });

  // ---------- Pie Chart ----------
  const CATEGORY_COLORS = {
    "Food": "#ef4444",
    "Coffee": "#f97316",
    "Transport": "#eab308",
    "Bills": "#84cc16",
    "Shopping": "#22c55e",
    "Subscriptions": "#14b8a6",
    "Health": "#06b6d4",
    "Entertainment": "#3b82f6",
    "Travel": "#8b5cf6",
    "Gifts": "#d946ef",
    "Other": "#94a3b8"
  };
  
  function renderPieChart(){
    // Get expenses by category for current month
    const currentMonth = els.monthFilter.value;
    const expenses = items.filter(it => {
      if(it.type !== "expense") return false;
      if(currentMonth !== "all" && yyyyMm(it.date) !== currentMonth) return false;
      return true;
    });
    
    const byCategory = {};
    let total = 0;
    for(const it of expenses){
      byCategory[it.category] = (byCategory[it.category] || 0) + it.amount;
      total += it.amount;
    }
    
    // Sort by amount
    const sorted = Object.entries(byCategory).sort((a,b) => b[1] - a[1]);
    
    if(sorted.length === 0 || total === 0){
      els.pieChart.style.background = "rgba(148,163,184,.2)";
      els.pieChart.innerHTML = '<div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:12px;color:var(--muted)">Nema podataka</div>';
      els.pieLegend.innerHTML = "";
      return;
    }
    
    // Build conic gradient
    let gradientParts = [];
    let currentAngle = 0;
    
    for(const [cat, amount] of sorted){
      const pct = (amount / total) * 100;
      const color = CATEGORY_COLORS[cat] || "#94a3b8";
      gradientParts.push(`${color} ${currentAngle}deg ${currentAngle + pct * 3.6}deg`);
      currentAngle += pct * 3.6;
    }
    
    els.pieChart.style.background = `conic-gradient(${gradientParts.join(", ")})`;
    els.pieChart.innerHTML = "";
    
    // Legend
    els.pieLegend.innerHTML = sorted.slice(0, 6).map(([cat, amount]) => {
      const pct = ((amount / total) * 100).toFixed(1);
      const color = CATEGORY_COLORS[cat] || "#94a3b8";
      return `
        <div class="pie-legend-item">
          <div class="pie-legend-dot" style="background:${color}"></div>
          <div class="pie-legend-label">${cat}</div>
          <div class="pie-legend-value">${pct}%</div>
        </div>
      `;
    }).join("");
  }

  // ---------- Line Chart ----------
  function renderLineChart(){
    const svg = els.lineChart;
    const width = 400;
    const height = 160;
    const padding = { top: 20, right: 15, bottom: 30, left: 45 };
    
    // Get last 14 days
    const days = [];
    const today = new Date();
    for(let i = 13; i >= 0; i--){
      const d = new Date(today);
      d.setDate(today.getDate() - i);
      days.push(d.toISOString().slice(0,10));
    }
    
    // Sum expenses per day
    const dailyExpenses = days.map(day => {
      return items
        .filter(it => it.type === "expense" && it.date === day)
        .reduce((sum, it) => sum + it.amount, 0);
    });
    
    const maxVal = Math.max(...dailyExpenses, 10);
    
    const chartWidth = width - padding.left - padding.right;
    const chartHeight = height - padding.top - padding.bottom;
    
    // Build path
    const points = dailyExpenses.map((val, i) => {
      const x = padding.left + (i / (days.length - 1)) * chartWidth;
      const y = padding.top + chartHeight - (val / maxVal) * chartHeight;
      return { x, y, val, day: days[i] };
    });
    
    const pathD = points.map((p, i) => `${i === 0 ? 'M' : 'L'} ${p.x} ${p.y}`).join(" ");
    
    // Area fill
    const areaD = pathD + ` L ${points[points.length-1].x} ${padding.top + chartHeight} L ${points[0].x} ${padding.top + chartHeight} Z`;
    
    // Grid lines
    const gridLines = [0, 0.25, 0.5, 0.75, 1].map(pct => {
      const y = padding.top + chartHeight * (1 - pct);
      const val = (maxVal * pct).toFixed(0);
      return `
        <line x1="${padding.left}" y1="${y}" x2="${width - padding.right}" y2="${y}" stroke="rgba(148,163,184,.15)" stroke-dasharray="3,3"/>
        <text x="${padding.left - 8}" y="${y + 4}" fill="var(--muted)" font-size="10" text-anchor="end" font-family="var(--mono)">${val}</text>
      `;
    }).join("");
    
    // X-axis labels (show every 2nd day)
    const xLabels = points.filter((_, i) => i % 2 === 0).map(p => {
      const label = p.day.slice(8); // Just day number
      return `<text x="${p.x}" y="${height - 8}" fill="var(--muted)" font-size="10" text-anchor="middle">${label}.</text>`;
    }).join("");
    
    // Dots
    const dots = points.map(p => 
      `<circle cx="${p.x}" cy="${p.y}" r="4" fill="var(--accent)" stroke="var(--bg)" stroke-width="2"/>`
    ).join("");
    
    svg.innerHTML = `
      ${gridLines}
      <path d="${areaD}" fill="url(#lineGradient)" opacity="0.3"/>
      <path d="${pathD}" fill="none" stroke="var(--accent)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      ${dots}
      ${xLabels}
      <defs>
        <linearGradient id="lineGradient" x1="0%" y1="0%" x2="0%" y2="100%">
          <stop offset="0%" stop-color="var(--accent)" stop-opacity="0.4"/>
          <stop offset="100%" stop-color="var(--accent)" stop-opacity="0"/>
        </linearGradient>
      </defs>
    `;
  }

  // ---------- Update Charts on Render ----------
  const originalRender = render;
  render = function(){
    originalRender();
    updateWeeklyLimit();
    renderPieChart();
    renderLineChart();
  };
  
  // Initial render
  render();
</script>
</body>
</html>
